<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java New IO 类库 | KeepJava</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Java New IO 类库">
    <meta name="keywords" content="Java New IO 类库">
    <link rel="preload" href="/KeepJava/assets/css/0.styles.0321c629.css" as="style"><link rel="preload" href="/KeepJava/assets/js/app.95e4ac80.js" as="script"><link rel="preload" href="/KeepJava/assets/js/2.73d6ef14.js" as="script"><link rel="preload" href="/KeepJava/assets/js/34.e9f2b7c9.js" as="script"><link rel="prefetch" href="/KeepJava/assets/js/10.f77a3b1c.js"><link rel="prefetch" href="/KeepJava/assets/js/11.f2c39f13.js"><link rel="prefetch" href="/KeepJava/assets/js/12.7295ba16.js"><link rel="prefetch" href="/KeepJava/assets/js/13.cc733961.js"><link rel="prefetch" href="/KeepJava/assets/js/14.c0a99400.js"><link rel="prefetch" href="/KeepJava/assets/js/15.e38b5c52.js"><link rel="prefetch" href="/KeepJava/assets/js/16.8118b0f3.js"><link rel="prefetch" href="/KeepJava/assets/js/17.8a8fe6dc.js"><link rel="prefetch" href="/KeepJava/assets/js/18.6432444b.js"><link rel="prefetch" href="/KeepJava/assets/js/19.a3be88a3.js"><link rel="prefetch" href="/KeepJava/assets/js/20.c5e50ea4.js"><link rel="prefetch" href="/KeepJava/assets/js/21.964f1dfe.js"><link rel="prefetch" href="/KeepJava/assets/js/22.0dcbf95f.js"><link rel="prefetch" href="/KeepJava/assets/js/23.ced2e82f.js"><link rel="prefetch" href="/KeepJava/assets/js/24.6351a6c5.js"><link rel="prefetch" href="/KeepJava/assets/js/25.3cc78923.js"><link rel="prefetch" href="/KeepJava/assets/js/26.87ab7653.js"><link rel="prefetch" href="/KeepJava/assets/js/27.ebe07d00.js"><link rel="prefetch" href="/KeepJava/assets/js/28.e32b4030.js"><link rel="prefetch" href="/KeepJava/assets/js/29.a39dc7ab.js"><link rel="prefetch" href="/KeepJava/assets/js/3.596aa5f2.js"><link rel="prefetch" href="/KeepJava/assets/js/30.a7ef1e11.js"><link rel="prefetch" href="/KeepJava/assets/js/31.386e222b.js"><link rel="prefetch" href="/KeepJava/assets/js/32.85324444.js"><link rel="prefetch" href="/KeepJava/assets/js/33.1775ff36.js"><link rel="prefetch" href="/KeepJava/assets/js/35.4b7e161f.js"><link rel="prefetch" href="/KeepJava/assets/js/36.39e8eff2.js"><link rel="prefetch" href="/KeepJava/assets/js/37.90259285.js"><link rel="prefetch" href="/KeepJava/assets/js/38.d838dba8.js"><link rel="prefetch" href="/KeepJava/assets/js/39.aab402f0.js"><link rel="prefetch" href="/KeepJava/assets/js/4.a6f55f5d.js"><link rel="prefetch" href="/KeepJava/assets/js/40.1e1951fb.js"><link rel="prefetch" href="/KeepJava/assets/js/41.b994974d.js"><link rel="prefetch" href="/KeepJava/assets/js/42.77236de4.js"><link rel="prefetch" href="/KeepJava/assets/js/43.f1cd7a56.js"><link rel="prefetch" href="/KeepJava/assets/js/44.b9cf68c3.js"><link rel="prefetch" href="/KeepJava/assets/js/45.d949d581.js"><link rel="prefetch" href="/KeepJava/assets/js/46.3306095e.js"><link rel="prefetch" href="/KeepJava/assets/js/47.1c08e86c.js"><link rel="prefetch" href="/KeepJava/assets/js/48.8c0802c7.js"><link rel="prefetch" href="/KeepJava/assets/js/49.b513c38f.js"><link rel="prefetch" href="/KeepJava/assets/js/5.be33ac2d.js"><link rel="prefetch" href="/KeepJava/assets/js/50.a91e4a91.js"><link rel="prefetch" href="/KeepJava/assets/js/51.94807067.js"><link rel="prefetch" href="/KeepJava/assets/js/52.55860f57.js"><link rel="prefetch" href="/KeepJava/assets/js/53.65662d2d.js"><link rel="prefetch" href="/KeepJava/assets/js/6.c9a4e2e1.js"><link rel="prefetch" href="/KeepJava/assets/js/7.6d22e957.js"><link rel="prefetch" href="/KeepJava/assets/js/8.4b0668c3.js"><link rel="prefetch" href="/KeepJava/assets/js/9.c098ded9.js">
    <link rel="stylesheet" href="/KeepJava/assets/css/0.styles.0321c629.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/KeepJava/" class="home-link router-link-active"><img src="/KeepJava/assets/logo/java.svg" alt="KeepJava" class="logo"> <span class="site-name can-hide">KeepJava</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/KeepJava/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java SE" class="dropdown-title"><span class="title">Java SE</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java SE" class="mobile-dropdown-title"><span class="title">Java SE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/introduction/" class="nav-link">
  Java 语言基础
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/version/" class="nav-link">
  Java 发展简史
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/object/" class="nav-link">
  面向对象编程
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/reflection/" class="nav-link">
  Java 反射
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/annotation/" class="nav-link">
  Java 注解
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/exceptions/" class="nav-link">
  Java 异常
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/generics/" class="nav-link">
  Java 泛型
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/collection/" class="nav-link">
  Java 集合
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/io/" class="nav-link router-link-active">
  Java IO
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/concurrency/" class="nav-link">
  Java 并发编程
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/skill/" class="nav-link">
  Java 额外技能
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java EE" class="dropdown-title"><span class="title">Java EE</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java EE" class="mobile-dropdown-title"><span class="title">Java EE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/KeepJava/" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/KeepJava/" class="nav-link">
  Spring Boot
</a></li><li class="dropdown-subitem"><a href="/KeepJava/" class="nav-link">
  Spring MVC
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          非关系型 (NoSQL)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/KeepJava/db/mongo/" class="nav-link">
  MongoDB
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/KeepJava/" class="nav-link">
  分布式
</a></div><div class="nav-item"><a href="/KeepJava/" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/KeepJava/solution/" class="nav-link">
  解决方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="思想|概念" class="dropdown-title"><span class="title">思想|概念</span> <span class="arrow down"></span></button> <button type="button" aria-label="思想|概念" class="mobile-dropdown-title"><span class="title">思想|概念</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/KeepJava/idea/patterns/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><a href="/KeepJava/tools/" class="nav-link">
  工具|技能
</a></div> <a href="https://github.com/pycrab" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/KeepJava/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java SE" class="dropdown-title"><span class="title">Java SE</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java SE" class="mobile-dropdown-title"><span class="title">Java SE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/introduction/" class="nav-link">
  Java 语言基础
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/version/" class="nav-link">
  Java 发展简史
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/object/" class="nav-link">
  面向对象编程
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/reflection/" class="nav-link">
  Java 反射
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/annotation/" class="nav-link">
  Java 注解
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/exceptions/" class="nav-link">
  Java 异常
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/generics/" class="nav-link">
  Java 泛型
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/collection/" class="nav-link">
  Java 集合
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/io/" class="nav-link router-link-active">
  Java IO
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/concurrency/" class="nav-link">
  Java 并发编程
</a></li><li class="dropdown-item"><!----> <a href="/KeepJava/jdk/skill/" class="nav-link">
  Java 额外技能
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java EE" class="dropdown-title"><span class="title">Java EE</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java EE" class="mobile-dropdown-title"><span class="title">Java EE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/KeepJava/" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/KeepJava/" class="nav-link">
  Spring Boot
</a></li><li class="dropdown-subitem"><a href="/KeepJava/" class="nav-link">
  Spring MVC
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          非关系型 (NoSQL)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/KeepJava/db/mongo/" class="nav-link">
  MongoDB
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/KeepJava/" class="nav-link">
  分布式
</a></div><div class="nav-item"><a href="/KeepJava/" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/KeepJava/solution/" class="nav-link">
  解决方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="思想|概念" class="dropdown-title"><span class="title">思想|概念</span> <span class="arrow down"></span></button> <button type="button" aria-label="思想|概念" class="mobile-dropdown-title"><span class="title">思想|概念</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/KeepJava/idea/patterns/" class="nav-link">
  设计模式
</a></li></ul></div></div><div class="nav-item"><a href="/KeepJava/tools/" class="nav-link">
  工具|技能
</a></div> <a href="https://github.com/pycrab" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java New IO 类库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/KeepJava/jdk/io/new-io.html#缓冲区-buffer" class="sidebar-link">缓冲区 Buffer</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/KeepJava/jdk/io/new-io.html#通道-channel" class="sidebar-link">通道 Channel</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/KeepJava/jdk/io/new-io.html#文件-io-通道" class="sidebar-link">文件 IO 通道</a></li><li class="sidebar-sub-header"><a href="/KeepJava/jdk/io/new-io.html#网络-io-通道" class="sidebar-link">网络 IO 通道</a></li></ul></li><li><a href="/KeepJava/jdk/io/new-io.html#选择器-selector" class="sidebar-link">选择器 Selector</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/KeepJava/jdk/io/new-io.html#管道-pipe" class="sidebar-link">管道 Pipe</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="缓冲区-buffer"><a href="#缓冲区-buffer" class="header-anchor">🎋</a> 缓冲区 Buffer</h2> <p>缓冲区是基本类型（除了 boolean 类型）的元素的线性序列，数据的读写都是对缓冲区的操作。以下缓冲区都是抽象类：</p> <p><img src="https://pycrab.github.io/KeepJava/assets/media/jdk-io-new-io-buffer1.png" alt="缓冲区类图.png"></p> <p>缓冲区除了放置基本元素，还有四个控制读写的属性：</p> <ul><li>capacity，缓冲区的总容量</li> <li>limit，缓冲区内可以操作的数据的总量</li> <li>position，当前读写的位置，默认是 0</li> <li>mark，标记位置，用来多次读取数据时重置 position，默认是 -1</li></ul> <p>缓冲区通过这四个位置属性来控制读写，其中，它们是严格遵守 mark &lt;= position &lt;= limit &lt;= capacity 的，并且 position &gt;= 0。</p> <p>缓冲区提供的方法，部分支持链式调用，如下：</p> <ul><li><p>创建缓冲区</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 在 Java 堆内存中创建缓冲区</span>
<span class="token comment">// 第一种：通过 allocate 静态方法创建空缓冲区，其中，capacity 会被初始化为指定大小，limit 初始化为 capacity 大小，position 初始化为 0，mark 未定义。每个位置的值都初始化为 0</span>
<span class="token keyword">final</span> <span class="token class-name">IntBuffer</span> intBuffer <span class="token operator">=</span> <span class="token class-name">IntBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pos=0 lim=100 cap=100</span>

<span class="token comment">// 第二种：通过 wrap 静态方法根据数组创建缓冲区，其中，capacity 和 limit 会初始化为数组大小，position 初始化为 0，mark 未定义。</span>
<span class="token keyword">final</span> <span class="token class-name">CharBuffer</span> charBuffer <span class="token operator">=</span> <span class="token class-name">CharBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pos=0 lim=4 cap=4</span>

<span class="token comment">// 在本机内存直接创建缓冲区，在该缓冲区中，JVM 尽最大努力直接调用操作系统底层 IO 进行读写，而不复制到中间缓冲区。</span>
<span class="token comment">// 第一种：通过 allocateDirect 静态方法直接创建空缓冲区</span>
<span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pos=0 lim=10 cap=10</span>

<span class="token comment">// 第二种：通过 FileChannel 的 map 方法将文件直接映射到内存区域 MappedByteBuffer</span>

<span class="token comment">// 通过 asReadOnlyBuffer() 方法将缓冲区可以标记为只读缓冲区</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p>读写缓冲区，当进行读写操作时，position 会往后移动直到最大为 limit。对缓冲区的读写都是按队列先进先出，是单向的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 通过 get() 方法及其重载方法读</span>
<span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 put() 方法及其重载方法写</span>
intBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 需要注意的是，对指定下标进行读写时，position 是不变的。</span>
<span class="token comment">// 如果下标位置不可用，则会抛出 IndexOutOfBoundsException 异常；如果对只读缓冲区写入，会抛出 ReadOnlyBufferException 异常。比如:</span>
intBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
intBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>属性重置方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 转为写模式（清空操作）：初始化缓冲区，将 position 置为 0，limit 置为 capacity，mark 置为 -1</span>
intBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 转为读模式：将 position 置为 0，limit 置为 position，mark 置为 -1</span>
intBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 倒带操作：将 position 置为 0，mark 置为 -1</span>
intBuffer<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>标记 / 重置缓冲区</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 标记当前位置，将 mark 置为 position</span>
intBuffer<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 回到标记的位置，将 position 置为 mark</span>
intBuffer<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注意，一定先 mark 标记后才能 reset，否则会报 InvalidMarkException 异常，因为 mark 默认 -1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>转换缓冲区</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ByteBuffer 提供了 asXXX 方法可以转换为 其它类型的缓冲区，如 asCharBuffer()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h2 id="通道-channel"><a href="#通道-channel" class="header-anchor">🎋</a> 通道 Channel</h2> <p>通道是用来连接内存和磁盘文件（或外部设备、网络、程序）的。它主要有四个抽象类：</p> <p><img src="https://pycrab.github.io/KeepJava/assets/media/jdk-io-new-io-channel1.png" alt="通道 Channel 类图.png"></p> <h3 id="文件-io-通道"><a href="#文件-io-通道" class="header-anchor">🎋</a> 文件 IO 通道</h3> <p>文件通道 FileChannel 是用于读写、映射和操作文件的通道。有三个类提供了打开文件通道的 getChannel() 方法，分别是：</p> <ul><li><p>打开读取通道：FileInputStream</p></li> <li><p>打开写入通道：FileOutputStream</p></li> <li><p>打开随机访问通道：RandomAccessFile</p> <ul><li>根据随机访问文件的模式 Mode，可以指定是可读 r、可读写 rw、读写并将文件内容更改同步到磁盘 rwd、读写并将文件内容及元数据的更改同步到磁盘 rws。</li></ul></li></ul> <p>FileChannel 类本身提供了 <code>open(Path path, OpenOption... options)</code> 方法根据文件 Path 打开一个文件通道，使用 options 指定文件通道类型。</p> <p>FileChannel 提供的方法如下：</p> <ul><li><p>传统文件读写</p> <ul><li><p>从文件读出数据并读入缓冲区 <code>read(ByteBuffer dst)</code></p></li> <li><p>从缓冲区读出数据并写入文件 <code>write(ByteBuffer src)</code></p> <p>使用通道和缓冲区进行一次文件传统读写的示例如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">FileChannel</span> inChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">FileChannel</span> outChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;task.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>inChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化为读模式</span>
    outChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化为写模式</span>
<span class="token punctuation">}</span>
buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul></li> <li><p>基于 sendfile 系统调用的文件拷贝</p> <ul><li>将当前通道内的文件写入目的通道 <code>transferTo(long position, long count, WritableByteChannel target)</code></li> <li>将源通道的数据读入当前文件通道 <code>transferFrom(ReadableByteChannel src, long position, long count)</code></li></ul></li> <li><p>基于 mmap 内存映射的文件拷贝</p> <ul><li><code>map(MapMode mode, long position, long size)</code> 方法将文件从 position 位置开始的 size 大小的块映射为内存区域。适用于大文件读操作，如 MD5 校验。</li></ul></li></ul> <h3 id="网络-io-通道"><a href="#网络-io-通道" class="header-anchor">🎋</a> 网络 IO 通道</h3> <p>通过上面的 Channel 继承类图我们可以看到，DatagramChannel、SocketChannel 和 ServerSocketChannel 都继承了 SelectableChannel，这三个通道同时也实现了 NetworkChannel 接口，所以说网络 IO 就是依靠这三个通道通信。它们是：</p> <ul><li>用于 UDP 网络 IO 的数据报通道 DatagramChannel</li> <li>用于  TCP 网络 IO 的面向流的客户端通道 SocketChannel 和面向流的服务端通道 ServerSocketChannel</li></ul> <p>打开网络 IO 通道的方式有：</p> <ul><li>通道的 <code>open()</code> 方法</li> <li>SelectorProvider 类提供的静态方法，它等同于通道的 <code>open()</code> 方法
<ul><li><code>openDatagramChannel()</code></li> <li><code>openSocketChannel()</code></li> <li><code>openServerSocketChannel()</code></li></ul></li> <li>传统流的 <code>getChannel()</code> 方法
<ul><li>DatagramSocket #getChannel()</li> <li>Socket #getChannel()</li> <li>ServerSocket #getChannel()</li></ul></li></ul> <p>SelectableChannel 抽象类提供了 <code>configureBlocking(boolean block)</code> 方法开启非阻塞模式，使用非阻塞的多路复用更有效（需要在注册之前开启）。</p> <div class="custom-block warning"><p class="custom-block-title">关闭通道</p> <p>关闭通道使用 <code>close()</code> 方法，关闭后不能操作，否则会抛异常 ClosedChannelException。</p></div> <h2 id="选择器-selector"><a href="#选择器-selector" class="header-anchor">🎋</a> 选择器 Selector</h2> <p>选择器 Selector 是 SelectableChannel 的多路复用器，也就是说选择器 Selector 只用于以上三种网络通信。如何使用选择器呢？</p> <p>1、首先，开启一个选择器</p> <p>有两种方式：</p> <ul><li><p>Selector 类的静态方法 <code>open()</code></p></li> <li><p>SelectorProvider 类实例的 <code>openSelector()</code> 方法</p></li></ul> <p>2、将通道注册到选择器上</p> <p>SelectableChannel 抽象类提供了 <code>register(Selector sel, int ops, Object att)</code> 方法将通道注册到选择器上，该注册方法需要提供要注册的选择器、目标操作、和一个附加对象（可为 null）。其中，目标操作 ops 主要有四类：</p> <ul><li><em>SelectionKey.OP_READ</em>，通道已准备好进行读取</li> <li><em>SelectionKey.OP_WRITE</em>，通道已准备好进行写入</li> <li><em>SelectionKey.OP_CONNECT</em>，通道已准备好进行连接</li> <li><em>SelectionKey.OP_ACCEPT</em>，通道已准备好接受其它连接</li></ul> <p>3、选择器轮询，获取满足目标操作的 SelectionKey 的合集</p> <p>调用 Selector 的 <code>selectedKeys()</code>方法可以获得已就绪的通道的 SelectionKey 集合。</p> <p>Selector 选择器持有代表已注册通道的选择键 SelectionKey 的三种集合，并提供方法来获取：</p> <ul><li>keys set ：所有 SelectionKey 的集合，只有键失效和通道关闭才会从此集合删除，通过 <code>keys()</code> 方法获取</li> <li>selected-key set ：检测就绪的 SelectionKey 的集合，通过 <code>selectedKeys()</code> 方法获取</li> <li>cancelled-key set ：SelectionKey 已取消但是对应的通道未关闭的 SelectionKey 的集合，无法获取</li></ul> <p>4、通过 SelectionKey 获得对应的通道，进行 IO 操作</p> <p>register 注册方法会返回注册好的 SelectionKey 对象，该对象有以下方法来探测通道及状态：</p> <ul><li>获取通道 <code>channel()</code></li> <li>对应通道是否可读 <code>isReadable()</code></li> <li>对应通道是否可写 <code>isWritable()</code></li> <li>对应通道是否已连接 <code>isConnectable()</code></li> <li>对应通道是否准备好接受新的 socket 连接 <code>isAcceptable()</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">IO 多路复用</p> <p>当已注册的通道满足目标操作时，Selector 选择器通过轮询会获得目标操作的 SelectionKey 选择键集合，通过选择键就可以获得对应的通道，进而执行通道的 IO 操作。</p></div> <h2 id="管道-pipe"><a href="#管道-pipe" class="header-anchor">🎋</a> 管道 Pipe</h2> <p>传统 IO 中使用管道流进行线程之间的 IO 通信，Java New IO 提供了 Pipe 类进行线程间的通信。</p> <p>Pipe 管道提供了一对单向的通道，一个是可写的 Pipe.SinkChannel 通道，一个是可读的 Pipe.SourceChannel 通道。</p> <p>创建一个管道使用 <code>open()</code> 方法，获取通道通过管道实例的 <code>sink()</code> 方法和 <code>source()</code> 方法。</p> <hr> <div class="custom-block danger"><p class="custom-block-title">参考文献</p> <ul><li>博客园 rickiyang <a href="https://www.cnblogs.com/rickiyang/p/13265043.html" target="_blank" rel="noopener noreferrer">零拷贝(Zero-copy) 浅析及其应用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>知乎专栏 美团技术团队 <a href="https://zhuanlan.zhihu.com/p/23488863" target="_blank" rel="noopener noreferrer">Java NIO 浅析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/pycrab/KeepJava/edit/master/jdk/io/new-io.md" target="_blank" rel="noopener noreferrer">Edit Me On Github</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2020/12/3 下午3:48:31</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/KeepJava/jdk/io/" class="prev router-link-active">
        Java IO
      </a></span> <span class="next"><a href="/KeepJava/jdk/io/new-io2.html">
        Java New IO 2 类库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/KeepJava/assets/js/app.95e4ac80.js" defer></script><script src="/KeepJava/assets/js/2.73d6ef14.js" defer></script><script src="/KeepJava/assets/js/34.e9f2b7c9.js" defer></script>
  </body>
</html>
